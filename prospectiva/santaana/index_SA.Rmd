---
title: "Residenciales en 10 km desde el proyecto"
output: 
  flexdashboard::flex_dashboard:
    theme: cerulean
    orientation: columns
    vertical_layout: fill
    navbar:
      - {icon: "fa-cc", href: "https://geoimaginarte.github.io/mysite", align: right }
      - {icon: "fa-home", href: "https://prospectivacr.com", align: right }
---

```{r message=FALSE, warning=FALSE, echo=FALSE, results="hide"}

#Librerias----

library(dplyr)
library(crosstalk)
library(leaflet)
library(flexdashboard)
library(DT)
library(RSQLite)
library(sf)
library(rgdal)
library(leaflet.extras)
library(leafem)
library(htmltools)
library(summarywidget)
library(readxl)

#Data----

dir <- "E:/Trabajos Fran/Prospectiva investigación de mercado/Residenciales_SantaAna_near/Resi_SA.gpkg"
con <- dbConnect(RSQLite::SQLite(), dbname = dir)

layers <- ogrListLayers(dir)
resi <- st_read(dir, layer="Resi_Urb_near", query = "Select id, Nombre, round(Area, 2) as Area, st_centroid(geom) as geom from Resi_Urb_near")
resi_p <- st_read(dir, layer="Resi_Urb_near")
buffer <- st_read(dir, layer="Buffer10km")
proy <- st_read(dir, layer="Proyecto")

invent <- read_excel("E:/Trabajos Fran/Prospectiva investigación de mercado/Residenciales_SantaAna_near/Datos/DATASET_ENINVENTARIO.xlsx", sheet = "Dataset")

#Uniones
resi_inv <- left_join(resi, invent, by = c("id"="ID"))
resi_inv <- resi_inv %>% filter(EN_INVENTARIO == "SI")

resi_p1 <- left_join(resi_p, invent, by = c("id"="ID"))
resi_p1 <- resi_p1 %>% filter(EN_INVENTARIO == "SI")

dist <- st_read("G:/Sig Datos/Distritos/DistritosIGN.gpkg", layer="DistritosGAM")

shared_resi <- SharedData$new(resi_inv)

#Iconos----

resicon <- iconList(
  Horizontal = makeIcon("horizontal.png", 18),
  Vertical = makeIcon("vertical.png", 18),
  Lote = makeIcon("lote.png", 18)
)

proyicon <- makeIcon(
  iconUrl = "project.png", 18)

densicon <- makeIcon(
  iconUrl = "project.png", 18)

#Mapa----

map_top <- leaflet(width = "100%")%>%
                  addTiles(group = "OSM") %>%
                  addProviderTiles(providers$CartoDB.DarkMatter, group = "Calles en oscuro") %>%
                  addProviderTiles(providers$Esri.WorldImagery, group = "Satelite") %>%
                  setView(-84.18763889, 9.92698333, zoom = 12) %>% 
                  addPolygons(data= buffer, group = "Buffer 10 km",color = "red", weight = 3, stroke=1, fillOpacity = .05)%>%
                  addPolygons(data=dist, group="Distritos GAM", color = "#698eff", popup= paste0("Distrito: ", dist$distrito), fillOpacity = 0.05)%>%
                  addPolygons(data= resi_p1, group = "Limites Residenciales",color = "green", label = ~Nombre, weight = 3)%>%
                  addMarkers(data=proy, group = "Proyecto", icon = proyicon)%>%
                  addWebGLHeatmap(data = shared_resi, group = "Densidad de residenciales", size = "2000", units = "m", opacity = 0.5, gradientTexture = "deep-sea", alphaRange = 0.5) %>% 
                  addMarkers(data= shared_resi, group = "Residenciales", icon = ~resicon[TIPO], label = ~Nombre) %>% 
                  addLayersControl(position = "topleft",
                      baseGroups = c("OSM", "Calles en oscuro", "Satelite"),
                      overlayGroups = c("Proyecto", "Buffer 10 km", "Residenciales", "Densidad de residenciales","Limites Residenciales","Distritos GAM"),
                      options = layersControlOptions(collapsed = F))%>%
                  
                  addMiniMap(
                    tiles = providers$Esri.WorldStreetMap,
                    toggleDisplay = TRUE,
                    minimized = TRUE,
                    position = "topright")%>%
                  addMeasure(
                      position = "topright",
                      primaryLengthUnit = "meters",
                      primaryAreaUnit = "sqmeters",
                      activeColor = "#3D535D",
                      completedColor = "#7D4479")%>%
                  addResetMapButton() %>%
                  addFullscreenControl(position = "bottomleft")%>%
                  addControl(html = c("<img src='vertical.png' height=18 width=18>Verticales<br/>", "<img src='horizontal.png' height=18 width=18>Horizontal<br/>", "<img src='lote.png' height=18 width=18>Lotes<br/>", "<img src='density.png' height=18 width=18>Densidad de residenciales<br/>", "<img src='project.png' height=18 width=18>Proyecto<br/>"), position="bottomright") %>% 
                  addLegend(position = "bottomright",
                    colors = c("red","green", "#698eff"),
                    labels = c("Buffer","Limites Residenciales", "Distritos GAM"), opacity = .5,
                    title = "Leyenda") %>% 
                  addLogo("http://prospectivacr.com/wp-content/uploads/2018/03/perpectiva-logo.png", url = "http://prospectivacr.com/", position = "bottomleft", offset.x = 70, offset.y = 10, width = 204, height = 39)
                  

#Tabla-----

dt_resi <- datatable(shared_resi, extensions="Scroller", style="bootstrap", class="compact", width="100%",
    options=list(deferRender=TRUE, scrollY=300, scroller=TRUE, 
                 columnDefs = list(list(visible=FALSE, targets=c(7,4,25))))) %>% formatPercentage("% VENTA") %>% formatCurrency(c("PRECIOS(m²) DESDE", "PRECIOS(m²) HASTA" ,"PRECIOS(m²) PROMEDIO","PROMEDIO POR UNIDAD", "VALOR DE DISPONIBLES $")) %>% formatDate("INGRESO AL MERCADO", method = "toUTCString", params = list("no", list(timeZone = "UTC"))) %>% formatRound(c("ABSORCIÓN MENSUAL", "MESES EN INVENTARIO"), c(1,0))

```

Sidebar1 {.sidebar}
-----------------------------------------------------------------------

Cantidad de condominios, residencias o urbanizaciones: <b><big>`r summarywidget(shared_resi, statistic='count', column='Nombre')`</big></b>

```{r}
filter_checkbox("tipo", "Tipo de condominio o residencial", shared_resi, group = ~TIPO)
filter_slider("dispo", "Filtre por la categoria de disponibles", shared_resi, column = ~DISPONIBLES, post = " Disponibles")
filter_select("conurb", "Filtre por conurbano", shared_resi, group = ~CONURBANO, multiple = T)
filter_select("residencial", "Busque el nombre del condominio, residencial o urbanizacion", shared_resi, group = ~Nombre, multiple = T)

```



<p><p><p><p>
<b>Creado por:</b> Jose Francisco Nuñez O. [Web page](https://geoimaginarte.github.io/mysite)
<br><b>Fecha:</b> "`r format(Sys.time(), '%d %B %Y')`"
<br><b>Fuente:</b> API Open Street Map
<br><b>Para:</b> Prospectiva & TopBox Research
<p>
<p>

Column
-----------------

###

```{r}

map_top

```

### 

```{r}

dt_resi

```
```